# 核心引擎模块

<cite>
**本文档引用的文件**
- [InsightEngine/__init__.py](file://InsightEngine/__init__.py)
- [InsightEngine/agent.py](file://InsightEngine/agent.py)
- [InsightEngine/utils/config.py](file://InsightEngine/utils/config.py)
- [InsightEngine/state/state.py](file://InsightEngine/state/state.py)
- [MediaEngine/__init__.py](file://MediaEngine/__init__.py)
- [MediaEngine/agent.py](file://MediaEngine/agent.py)
- [MediaEngine/utils/config.py](file://MediaEngine/utils/config.py)
- [MediaEngine/state/state.py](file://MediaEngine/state/state.py)
- [QueryEngine/__init__.py](file://QueryEngine/__init__.py)
- [QueryEngine/agent.py](file://QueryEngine/agent.py)
- [QueryEngine/utils/config.py](file://QueryEngine/utils/config.py)
- [QueryEngine/state/state.py](file://QueryEngine/state/state.py)
- [ReportEngine/__init__.py](file://ReportEngine/__init__.py)
- [ReportEngine/agent.py](file://ReportEngine/agent.py)
- [ReportEngine/utils/config.py](file://ReportEngine/utils/config.py)
- [ReportEngine/state/state.py](file://ReportEngine/state/state.py)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构总览](#架构总览)
5. [详细组件分析](#详细组件分析)
6. [依赖关系分析](#依赖关系分析)
7. [性能考虑](#性能考虑)
8. [故障排除指南](#故障排除指南)
9. [结论](#结论)
10. [附录](#附录)

## 简介
本文件为 BettaFish 核心引擎模块的综合性技术文档，聚焦四大引擎：Insight Engine（私有数据库挖掘）、Media Engine（多模态内容分析）、Query Engine（精准信息搜索）与 Report Engine（智能报告生成）。文档从架构设计、数据流、状态管理、错误处理、配置选项到使用示例进行全面阐述，帮助开发者深入理解各引擎职责分工、协作方式与扩展路径。

## 项目结构
四大引擎模块采用“按引擎分层”的组织方式，每个引擎包含以下典型层次：
- agent.py：引擎主控制器，编排节点、工具与状态
- nodes/：推理节点集合（搜索、总结、反思、格式化等）
- tools/：外部工具封装（数据库查询、网络搜索、情感分析等）
- state/：状态数据结构与持久化
- utils/：配置、工具函数与辅助模块
- prompts/：提示词模板
- llms/：LLM 客户端封装

```mermaid
graph TB
subgraph "Insight Engine"
IE_Agent["agent.py"]
IE_State["state/state.py"]
IE_Config["utils/config.py"]
end
subgraph "Media Engine"
ME_Agent["agent.py"]
ME_State["state/state.py"]
ME_Config["utils/config.py"]
end
subgraph "Query Engine"
QE_Agent["agent.py"]
QE_State["state/state.py"]
QE_Config["utils/config.py"]
end
subgraph "Report Engine"
RE_Agent["agent.py"]
RE_State["state/state.py"]
RE_Config["utils/config.py"]
end
IE_Agent --> IE_State
IE_Agent --> IE_Config
ME_Agent --> ME_State
ME_Agent --> ME_Config
QE_Agent --> QE_State
QE_Agent --> QE_Config
RE_Agent --> RE_State
RE_Agent --> RE_Config
```

**图表来源**
- [InsightEngine/agent.py](file://InsightEngine/agent.py#L1-L980)
- [MediaEngine/agent.py](file://MediaEngine/agent.py#L1-L508)
- [QueryEngine/agent.py](file://QueryEngine/agent.py#L1-L474)
- [ReportEngine/agent.py](file://ReportEngine/agent.py#L1-L1736)

**章节来源**
- [InsightEngine/__init__.py](file://InsightEngine/__init__.py#L1-L13)
- [MediaEngine/__init__.py](file://MediaEngine/__init__.py#L1-L13)
- [QueryEngine/__init__.py](file://QueryEngine/__init__.py#L1-L13)
- [ReportEngine/__init__.py](file://ReportEngine/__init__.py#L1-L14)

## 核心组件
- 搜索与总结流水线：每个引擎均提供统一的研究流程，包含“生成报告结构 → 初始搜索与总结 → 反思循环 → 生成最终报告 → 保存输出”
- LLM 客户端：统一的 LLMClient 封装，支持不同引擎的 API Key、Base URL 与模型名配置
- 工具集：Insight 使用本地数据库查询与情感分析；Media 使用 Bocha/Anspire 多模态搜索；Query 使用 Tavily 新闻搜索
- 状态管理：标准化的数据类结构，支持 JSON 序列化与文件持久化，便于断点续跑与调试
- 报告装配：Report Engine 负责模板选择、布局设计、章节生成、IR 装订与 HTML 渲染

**章节来源**
- [InsightEngine/agent.py](file://InsightEngine/agent.py#L512-L547)
- [MediaEngine/agent.py](file://MediaEngine/agent.py#L133-L172)
- [QueryEngine/agent.py](file://QueryEngine/agent.py#L141-L180)
- [ReportEngine/agent.py](file://ReportEngine/agent.py#L424-L474)

## 架构总览
四大引擎采用“并行独立 + 统一装配”的架构：各引擎独立完成信息收集与总结，Report Engine 负责将三引擎报告与论坛日志整合为最终 HTML 报告。

```mermaid
graph TB
subgraph "输入"
Q["QueryEngine 报告"]
M["MediaEngine 报告"]
I["InsightEngine 报告"]
F["论坛日志"]
end
subgraph "Report Engine"
TE["模板选择"]
DL["文档布局"]
WB["篇幅规划"]
CG["章节生成"]
IR["IR 装订"]
HR["HTML 渲染"]
end
subgraph "输出"
HTML["HTML 报告"]
IR_OUT["IR/Manifest"]
end
Q --> TE
M --> TE
I --> TE
F --> TE
TE --> DL
DL --> WB
WB --> CG
CG --> IR
IR --> HR
HR --> HTML
IR --> IR_OUT
```

**图表来源**
- [ReportEngine/agent.py](file://ReportEngine/agent.py#L424-L631)

**章节来源**
- [ReportEngine/agent.py](file://ReportEngine/agent.py#L190-L253)

## 详细组件分析

### Insight Engine（私有数据库挖掘）
- 职责：基于本地数据库的深度挖掘，支持热点内容、话题搜索、评论抓取与情感分析
- 关键能力：
  - 关键词优化中间件：提升搜索质量
  - 聚类采样：对结果进行主题聚类，减少冗余
  - 情感分析：对查询结果进行多语言情感打分
- 数据流：搜索工具 → 关键词优化 → 结果去重/聚类 → 情感分析 → LLM 总结 → 状态更新 → 报告生成

```mermaid
sequenceDiagram
participant U as "用户"
participant A as "InsightAgent"
participant KW as "关键词优化"
participant DB as "本地数据库"
participant SA as "情感分析器"
participant L as "LLM"
U->>A : 提交查询
A->>KW : 优化关键词
KW-->>A : 返回优化后的关键词
loop 针对每个关键词
A->>DB : 执行数据库查询
DB-->>A : 返回搜索结果
end
A->>A : 去重与聚类采样
A->>SA : 对结果进行情感分析
SA-->>A : 返回情感分析结果
A->>L : 生成总结
L-->>A : 返回总结
A->>A : 更新状态与保存报告
```

**图表来源**
- [InsightEngine/agent.py](file://InsightEngine/agent.py#L190-L371)
- [InsightEngine/agent.py](file://InsightEngine/agent.py#L389-L434)

**章节来源**
- [InsightEngine/agent.py](file://InsightEngine/agent.py#L41-L103)
- [InsightEngine/agent.py](file://InsightEngine/agent.py#L190-L371)
- [InsightEngine/agent.py](file://InsightEngine/agent.py#L389-L510)
- [InsightEngine/utils/config.py](file://InsightEngine/utils/config.py#L13-L45)
- [InsightEngine/state/state.py](file://InsightEngine/state/state.py#L12-L259)

### Media Engine（多模态内容分析）
- 职责：基于 Bocha/Anspire 的多模态网络搜索，支持综合搜索、结构化数据查询、近实时新闻检索
- 关键能力：
  - 多工具适配：综合搜索、网页搜索、结构化数据、24小时/一周检索
  - 统一结果格式：将不同来源结果归一化为统一结构
- 数据流：LLM 生成搜索查询 → 选择搜索工具 → 执行网络搜索 → 结果归一化 → LLM 总结 → 状态更新 → 报告生成

```mermaid
sequenceDiagram
participant U as "用户"
participant A as "MediaAgent"
participant ST as "搜索工具集"
participant L as "LLM"
U->>A : 提交查询
A->>L : 生成搜索查询与工具选择
L-->>A : 返回查询与工具
A->>ST : 执行搜索
ST-->>A : 返回搜索结果
A->>A : 结果归一化
A->>L : 生成总结
L-->>A : 返回总结
A->>A : 更新状态与保存报告
```

**图表来源**
- [MediaEngine/agent.py](file://MediaEngine/agent.py#L98-L131)
- [MediaEngine/agent.py](file://MediaEngine/agent.py#L209-L289)

**章节来源**
- [MediaEngine/agent.py](file://MediaEngine/agent.py#L26-L72)
- [MediaEngine/agent.py](file://MediaEngine/agent.py#L98-L131)
- [MediaEngine/agent.py](file://MediaEngine/agent.py#L209-L372)
- [MediaEngine/utils/config.py](file://MediaEngine/utils/config.py#L16-L89)
- [MediaEngine/state/state.py](file://MediaEngine/state/state.py#L12-L293)

### Query Engine（精准信息搜索）
- 职责：基于 Tavily 的新闻搜索，支持基础新闻、深度分析、图片搜索、按日期检索
- 关键能力：
  - 日期参数校验：严格校验 YYYY-MM-DD 格式
  - 工具路由：根据 LLM 推荐选择具体搜索工具
- 数据流：LLM 生成查询 → 工具选择 → 执行搜索 → 结果归一化 → LLM 总结 → 状态更新 → 报告生成

```mermaid
sequenceDiagram
participant U as "用户"
participant A as "QueryAgent"
participant TA as "TavilyAgency"
participant L as "LLM"
U->>A : 提交查询
A->>L : 生成查询与工具选择
L-->>A : 返回查询与工具
A->>A : 校验日期参数
A->>TA : 执行搜索
TA-->>A : 返回搜索结果
A->>A : 结果归一化
A->>L : 生成总结
L-->>A : 返回总结
A->>A : 更新状态与保存报告
```

**图表来源**
- [QueryEngine/agent.py](file://QueryEngine/agent.py#L100-L140)
- [QueryEngine/agent.py](file://QueryEngine/agent.py#L217-L305)

**章节来源**
- [QueryEngine/agent.py](file://QueryEngine/agent.py#L26-L73)
- [QueryEngine/agent.py](file://QueryEngine/agent.py#L100-L140)
- [QueryEngine/agent.py](file://QueryEngine/agent.py#L217-L396)
- [QueryEngine/utils/config.py](file://QueryEngine/utils/config.py#L22-L80)
- [QueryEngine/state/state.py](file://QueryEngine/state/state.py#L12-L259)

### Report Engine（智能报告生成）
- 职责：统一装配三引擎报告与论坛日志，生成最终 HTML 报告
- 关键能力：
  - 模板选择与切片：根据查询与输入动态选择模板
  - 文档布局与篇幅规划：生成标题、目录与章节字数目标
  - 章节生成与 IR 装订：章节 JSON → IR → HTML 渲染
  - 流式事件与断点续跑：支持 SSE 事件与状态持久化
  - GraphRAG 增强：可选启用知识图谱增强章节生成
- 数据流：输入归一化 → 模板选择 → 布局设计 → 篇幅规划 → 章节生成 → IR 装订 → HTML 渲染 → 输出

```mermaid
sequenceDiagram
participant U as "用户/前端"
participant RA as "ReportAgent"
participant TS as "模板选择"
participant DL as "文档布局"
participant WB as "篇幅规划"
participant CG as "章节生成"
participant IR as "IR 装订"
participant HR as "HTML 渲染"
U->>RA : 提交查询与三引擎报告
RA->>TS : 选择模板
TS-->>RA : 返回模板
RA->>DL : 设计标题/目录
DL-->>RA : 返回布局
RA->>WB : 规划章节字数
WB-->>RA : 返回篇幅计划
RA->>CG : 逐章生成
CG-->>RA : 返回章节IR
RA->>IR : 装订IR/Manifest
IR-->>RA : 返回IR
RA->>HR : 渲染HTML
HR-->>U : 返回HTML/保存产物
```

**图表来源**
- [ReportEngine/agent.py](file://ReportEngine/agent.py#L424-L631)
- [ReportEngine/agent.py](file://ReportEngine/agent.py#L633-L800)

**章节来源**
- [ReportEngine/agent.py](file://ReportEngine/agent.py#L190-L253)
- [ReportEngine/agent.py](file://ReportEngine/agent.py#L424-L631)
- [ReportEngine/agent.py](file://ReportEngine/agent.py#L633-L800)
- [ReportEngine/utils/config.py](file://ReportEngine/utils/config.py#L12-L114)
- [ReportEngine/state/state.py](file://ReportEngine/state/state.py#L30-L143)

## 依赖关系分析
- 配置管理：各引擎使用 pydantic-settings 从 .env 与环境变量加载配置，字段命名规范统一
- 状态管理：各引擎状态结构一致，便于 Report Engine 统一处理
- LLM 客户端：统一封装，支持不同引擎的 API Key/Base URL/ModelName
- 工具适配：Insight 使用本地数据库与情感分析；Media 使用 Bocha/Anspire；Query 使用 Tavily

```mermaid
graph LR
CFG_I["Insight 配置"] --> AG_I["Insight Agent"]
CFG_M["Media 配置"] --> AG_M["Media Agent"]
CFG_Q["Query 配置"] --> AG_Q["Query Agent"]
CFG_R["Report 配置"] --> AG_R["Report Agent"]
AG_I --> ST_I["Insight 状态"]
AG_M --> ST_M["Media 状态"]
AG_Q --> ST_Q["Query 状态"]
AG_R --> ST_R["Report 状态"]
LLM["LLM 客户端"] --> AG_I
LLM --> AG_M
LLM --> AG_Q
LLM --> AG_R
```

**图表来源**
- [InsightEngine/utils/config.py](file://InsightEngine/utils/config.py#L13-L45)
- [MediaEngine/utils/config.py](file://MediaEngine/utils/config.py#L16-L89)
- [QueryEngine/utils/config.py](file://QueryEngine/utils/config.py#L22-L80)
- [ReportEngine/utils/config.py](file://ReportEngine/utils/config.py#L12-L114)

**章节来源**
- [InsightEngine/utils/config.py](file://InsightEngine/utils/config.py#L13-L45)
- [MediaEngine/utils/config.py](file://MediaEngine/utils/config.py#L16-L89)
- [QueryEngine/utils/config.py](file://QueryEngine/utils/config.py#L22-L80)
- [ReportEngine/utils/config.py](file://ReportEngine/utils/config.py#L12-L114)

## 性能考虑
- 搜索结果采样：Insight 引擎提供聚类采样策略，控制 LLM 输入规模，平衡覆盖率与质量
- 结果上限：各引擎通过配置项限制传递给 LLM 的结果数量，避免上下文溢出
- 超时与重试：统一的 API 超时与重试策略，GraphRAG 查询支持最大查询次数
- 图表与渲染：Report Engine 提供图表样式与 PDF 导出开关，兼顾渲染性能与输出质量

[本节为通用性能建议，无需列出具体文件来源]

## 故障排除指南
- 搜索工具参数校验：Query/Insight/Media 引擎均对日期格式进行严格校验，错误时自动降级为默认工具
- 情感分析降级：当情感分析模型初始化失败或被禁用时，系统将透传原始文本并记录警告
- 章节生成重试：Report Engine 对章节 JSON 解析失败提供最大尝试次数，必要时使用最佳候选进行兜底
- 日志隔离：Report Engine 使用专用日志文件与过滤器，避免与其他引擎日志混淆

**章节来源**
- [QueryEngine/agent.py](file://QueryEngine/agent.py#L75-L98)
- [InsightEngine/agent.py](file://InsightEngine/agent.py#L104-L128)
- [MediaEngine/agent.py](file://MediaEngine/agent.py#L73-L96)
- [ReportEngine/agent.py](file://ReportEngine/agent.py#L254-L335)
- [ReportEngine/agent.py](file://ReportEngine/agent.py#L722-L755)

## 结论
BettaFish 四大核心引擎通过统一的 LLM 客户端、标准化状态管理与清晰的流水线设计，实现了从私有数据库挖掘、多模态网络搜索到智能报告生成的完整闭环。Report Engine 作为装配中枢，将三引擎报告与论坛日志融合为高质量 HTML 报告，具备良好的扩展性与可维护性。

[本节为总结性内容，无需列出具体文件来源]

## 附录

### 使用示例与配置选项
- Insight Engine
  - 配置项：API Key、Base URL、模型名、数据库连接、最大反思次数、段落数、搜索超时、内容长度、默认搜索限制、LLM 结果上限、情感分析上限、输出目录、中间状态保存
  - 示例流程：初始化 Agent → 执行搜索工具 → 生成报告 → 保存状态与报告
- Media Engine
  - 配置项：多引擎 API Key/URL/ModelName、Bocha/Anspire API Key、搜索超时、内容长度、反思轮数、段落数、输出目录、中间状态保存
  - 示例流程：初始化 Agent → 选择搜索工具 → 执行搜索 → 归一化结果 → 生成报告
- Query Engine
  - 配置项：API Key、Base URL、模型名、Tavily API Key、搜索超时、内容长度、反思轮数、段落数、最大搜索结果数、输出目录、中间状态保存
  - 示例流程：初始化 Agent → 生成查询与工具 → 校验日期 → 执行搜索 → 归一化结果 → 生成报告
- Report Engine
  - 配置项：API Key/URL/ModelName、跨引擎修复 API Key/URL/ModelName、最大内容长度、输出目录、章节 JSON 目录、整本 IR 目录、最大尝试次数、模板目录、API 超时与重试、日志文件、PDF 导出、图表样式、GraphRAG 开关与查询上限
  - 示例流程：初始化 Agent → 输入归一化 → 模板选择 → 布局设计 → 篇幅规划 → 章节生成 → IR 装订 → HTML 渲染 → 输出

**章节来源**
- [InsightEngine/utils/config.py](file://InsightEngine/utils/config.py#L13-L45)
- [MediaEngine/utils/config.py](file://MediaEngine/utils/config.py#L16-L89)
- [QueryEngine/utils/config.py](file://QueryEngine/utils/config.py#L22-L80)
- [ReportEngine/utils/config.py](file://ReportEngine/utils/config.py#L12-L114)